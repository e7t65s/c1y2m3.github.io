<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="项目地址: https://github.com/c0ny1/upload-labs 边写边练，方法不是唯一的，只是简单的记录下思路 ~ Pass-01 - Pass-02 修改数据包MIME和文件名成功绕过 ~  Pass-03 查看源代码： 由于对首尾去空，利用正则匹配的特性，成功绕过： Content-Disposition: form-data; name=&amp;quot;upload_fil">
<meta property="og:type" content="article">
<meta property="og:title" content="upload-labs-writeup">
<meta property="og:url" content="http://yoursite.com/2018/11/02/upload-labs-writeup/index.html">
<meta property="og:site_name" content="c1y2m3’blog">
<meta property="og:description" content="项目地址: https://github.com/c0ny1/upload-labs 边写边练，方法不是唯一的，只是简单的记录下思路 ~ Pass-01 - Pass-02 修改数据包MIME和文件名成功绕过 ~  Pass-03 查看源代码： 由于对首尾去空，利用正则匹配的特性，成功绕过： Content-Disposition: form-data; name=&amp;quot;upload_fil">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdaf36e2711cd4e265a1e5c">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdb1b7aea3b4a3fed119d57">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdafc76db5aa647e4fd408e">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdb142950f8dd54d40f3f13">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdb20c99b521a5a85ebc8d7">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdb23c1ea3b4a3fed11b55a">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdbac359b521a5a85f015d5">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdbaffb50f8dd54d41467b3">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdbb2a4db5aa647e4035c18">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdbb61fdb5aa647e403e100">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdbbe50db5aa647e4052d49">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdbcb5fdb5aa647e40706be">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdbd9cb50f8dd54d4198868">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdbdd0e9b521a5a85f5e5c5">
<meta property="og:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdbdeb350f8dd54d419e1db">
<meta property="og:updated_time" content="2018-11-19T04:05:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="upload-labs-writeup">
<meta name="twitter:description" content="项目地址: https://github.com/c0ny1/upload-labs 边写边练，方法不是唯一的，只是简单的记录下思路 ~ Pass-01 - Pass-02 修改数据包MIME和文件名成功绕过 ~  Pass-03 查看源代码： 由于对首尾去空，利用正则匹配的特性，成功绕过： Content-Disposition: form-data; name=&amp;quot;upload_fil">
<meta name="twitter:image" content="https://www.yunzhijia.com/microblog/filesvr/5bdaf36e2711cd4e265a1e5c">
    
    
        
          
              <link rel="shortcut icon" href="/c1y2m3.github.io/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/c1y2m3.github.io/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/c1y2m3.github.io/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>upload-labs-writeup</title>
    <!-- styles -->
    <link rel="stylesheet" href="/c1y2m3.github.io/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/c1y2m3.github.io/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/c1y2m3.github.io/">Home</a></li>
         
          <li><a href="/c1y2m3.github.io/about/">About</a></li>
         
          <li><a href="/c1y2m3.github.io/archives/">Writing</a></li>
         
          <li><a href="/c1y2m3.github.io/projects_url">Projects</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/c1y2m3.github.io/2018/11/08/关于tw福客來渗透测试/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/c1y2m3.github.io/2018/10/29/域渗透之横向移动 /"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2018/11/02/upload-labs-writeup/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&text=upload-labs-writeup"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&title=upload-labs-writeup"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&is_video=false&description=upload-labs-writeup"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=upload-labs-writeup&body=Check out this article: http://yoursite.com/2018/11/02/upload-labs-writeup/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&title=upload-labs-writeup"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&title=upload-labs-writeup"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&title=upload-labs-writeup"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&title=upload-labs-writeup"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&name=upload-labs-writeup&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-03-查看源代码："><span class="toc-number">1.</span> <span class="toc-text">Pass-03 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-04-查看源代码"><span class="toc-number">2.</span> <span class="toc-text"> Pass-04  查看源代码:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-05-查看源代码："><span class="toc-number">3.</span> <span class="toc-text"> Pass-05 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-06-查看源代码："><span class="toc-number">4.</span> <span class="toc-text"> Pass-06 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-07-查看源代码："><span class="toc-number">5.</span> <span class="toc-text"> Pass-07 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-08-查看源代码："><span class="toc-number">6.</span> <span class="toc-text"> Pass-08 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-09-查看源代码："><span class="toc-number">7.</span> <span class="toc-text"> Pass-09 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-10-查看源代码："><span class="toc-number">8.</span> <span class="toc-text"> Pass-10 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-11-查看源代码："><span class="toc-number">9.</span> <span class="toc-text"> Pass-11 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#理解测试代码："><span class="toc-number">10.</span> <span class="toc-text">理解测试代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-12-查看源代码："><span class="toc-number">11.</span> <span class="toc-text"> Pass-12 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-13-查看源代码："><span class="toc-number">12.</span> <span class="toc-text"> Pass-13 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-14-查看源代码："><span class="toc-number">13.</span> <span class="toc-text"> Pass-14 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-15-查看源代码："><span class="toc-number">14.</span> <span class="toc-text"> Pass-15 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-16-查看源代码："><span class="toc-number">15.</span> <span class="toc-text"> Pass-16 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-17-查看源代码："><span class="toc-number">16.</span> <span class="toc-text"> Pass-17 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-18-查看源代码："><span class="toc-number">17.</span> <span class="toc-text"> Pass-18 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-19-查看源代码："><span class="toc-number">18.</span> <span class="toc-text"> Pass-19 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后记"><span class="toc-number">19.</span> <span class="toc-text"> 后记</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        upload-labs-writeup
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">c1y2m3’blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-11-01T16:34:14.000Z" itemprop="datePublished">2018-11-02</time>
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <pre><code>项目地址: https://github.com/c0ny1/upload-labs
</code></pre><p><code>边写边练，方法不是唯一的，只是简单的记录下思路 ~</code></p>
<p>Pass-01 - Pass-02 修改数据包MIME和文件名成功绕过 ~ </p>
<h2 id="Pass-03-查看源代码："><a href="#Pass-03-查看源代码：" class="headerlink" title="Pass-03 查看源代码："></a>Pass-03 查看源代码：</h2><p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdaf36e2711cd4e265a1e5c" alt=""></p>
<p><code>由于对首尾去空，利用正则匹配的特性，成功绕过：</code></p>
<p><code>Content-Disposition: form-data; name=&quot;upload_file&quot;; filename=&quot;2. php&quot;</code></p>
<hr>
<h2 id="Pass-04-查看源代码"><a href="#Pass-04-查看源代码" class="headerlink" title=" Pass-04  查看源代码:"></a> Pass-04  查看源代码:</h2><p><code>只是多了类型的验证，继续用Pass-03的方法，成功绕过.</code></p>
<hr>
<h2 id="Pass-05-查看源代码："><a href="#Pass-05-查看源代码：" class="headerlink" title=" Pass-05 查看源代码："></a> Pass-05 查看源代码：</h2><p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdb1b7aea3b4a3fed119d57" alt=""><br><code>又只是多加了部分类型的验证，依然继续采用Pass-03的方法，成功绕过，而且没有对后缀进行大小写统一，还可以通过大小写绕过。</code></p>
<hr>
<h2 id="Pass-06-查看源代码："><a href="#Pass-06-查看源代码：" class="headerlink" title=" Pass-06 查看源代码："></a> Pass-06 查看源代码：</h2><p><code>还是只加了部分类型的验证，继续采用Pass-03的方法，成功绕过。</code></p>
<hr>
<h2 id="Pass-07-查看源代码："><a href="#Pass-07-查看源代码：" class="headerlink" title=" Pass-07 查看源代码："></a> Pass-07 查看源代码：</h2><p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdafc76db5aa647e4fd408e" alt=""><br>没有对后缀名进行去”.”处理，利用windows特性，会自动去掉后缀名中最后的”.”，可在后缀名中加 ” . ”绕过。</p>
<p><code>Content-Disposition: form-data; name=&quot;upload_file&quot;; filename=&quot;2. php.&quot;</code></p>
<hr>
<h2 id="Pass-08-查看源代码："><a href="#Pass-08-查看源代码：" class="headerlink" title=" Pass-08 查看源代码："></a> Pass-08 查看源代码：</h2><p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdb142950f8dd54d40f3f13" alt=""></p>
<p>没有对后缀名进行去”::$DATA”处理，利用windows特性，可在后缀名中加” ::$DATA”绕过：</p>
<h2 id="Pass-09-查看源代码："><a href="#Pass-09-查看源代码：" class="headerlink" title=" Pass-09 查看源代码："></a> Pass-09 查看源代码：</h2><p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdb20c99b521a5a85ebc8d7" alt=""></p>
<p><code>第15行和之前不太一样，路径拼接的是处理后的文件名，于是构造info.php. . （点+空格+点），经过处理后，文件名变成info.php.，即可绕过。</code></p>
<hr>
<h2 id="Pass-10-查看源代码："><a href="#Pass-10-查看源代码：" class="headerlink" title=" Pass-10 查看源代码："></a> Pass-10 查看源代码：</h2><p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdb23c1ea3b4a3fed11b55a" alt=""><br><code>这里将黑名单后缀替换为空，这里用双写绕过。</code></p>
<p><code>Content-Disposition: form-data; name=&quot;upload_file&quot;; filename=&quot;cmd.pphphp&quot;</code></p>
<hr>
<h2 id="Pass-11-查看源代码："><a href="#Pass-11-查看源代码：" class="headerlink" title=" Pass-11 查看源代码："></a> Pass-11 查看源代码：</h2><pre><code>$ext_arr = array(&apos;jpg&apos;,&apos;png&apos;,&apos;gif&apos;);
$file_ext = substr($_FILES[&apos;upload_file&apos;][&apos;name&apos;],strrpos($_FILES[&apos;upload_file&apos;][&apos;name&apos;],&quot;.&quot;)+1);
if(in_array($file_ext,$ext_arr)){
    $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];
    $img_path = $_GET[&apos;save_path&apos;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;
</code></pre><p><code>substr(string,start,length) 规定要返回其中一部分的字符串。</code> </p>
<p><code>strrpos() 函数查找字符串在另一字符串中最后一次出现的位置。</code></p>
<p><code>注释：strrpos() 函数对大小写敏感。</code></p>
<h2 id="理解测试代码："><a href="#理解测试代码：" class="headerlink" title="理解测试代码："></a><code>理解测试代码：</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a = &apos;1.jpg&apos;;</span><br><span class="line">$file_ext = substr($a,strrpos($a,&quot;.&quot;)+1);</span><br><span class="line">var_dump($file_ext);</span><br><span class="line">?&gt;</span><br><span class="line">返回jpg</span><br></pre></td></tr></table></figure>
<p>分析代码：<br><code>$img_path = $_GET[&#39;save_path&#39;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</code></p>
<p>发现那个路径没有处理直接拼接上去了，所以可以利用00截断绕过，但是发现怎么截断都没有用</p>
<ul>
<li>截断条件：</li>
<li>php版本小于5.3.4 详情关注CVE-2006-7243</li>
<li>php的magic_quotes_gpc为OFF状态</li>
</ul>
<p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdbac359b521a5a85f015d5" alt=""></p>
<hr>
<h2 id="Pass-12-查看源代码："><a href="#Pass-12-查看源代码：" class="headerlink" title=" Pass-12 查看源代码："></a> Pass-12 查看源代码：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ext_arr = array(&apos;jpg&apos;,&apos;png&apos;,&apos;gif&apos;);</span><br><span class="line">$file_ext = substr($_FILES[&apos;upload_file&apos;][&apos;name&apos;],strrpos($_FILES[&apos;upload_file&apos;][&apos;name&apos;],&quot;.&quot;)+1);</span><br><span class="line">if(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">    $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];</span><br><span class="line">    $img_path = $_POST[&apos;save_path&apos;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</span><br></pre></td></tr></table></figure>
<p>和前面不同的是这次的save_path是通过post传过来的，还是利用00截断，不过这次要在二进制中修改， 因为post不会像get对%00进行自动解码。</p>
<p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdbaffb50f8dd54d41467b3" alt=""></p>
<hr>
<h2 id="Pass-13-查看源代码："><a href="#Pass-13-查看源代码：" class="headerlink" title=" Pass-13 查看源代码："></a> Pass-13 查看源代码：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function getReailFileType($filename)&#123;</span><br><span class="line">    $file = fopen($filename, &quot;rb&quot;);</span><br><span class="line">    $bin = fread($file, 2); //只读2字节</span><br><span class="line">    fclose($file);</span><br><span class="line">    $strInfo = @unpack(&quot;C2chars&quot;, $bin);    </span><br><span class="line">    $typeCode = intval($strInfo[&apos;chars1&apos;].$strInfo[&apos;chars2&apos;]);    </span><br><span class="line">    $fileType = &apos;&apos;;    </span><br><span class="line">    switch($typeCode)&#123;      </span><br><span class="line">        case 255216:            </span><br><span class="line">            $fileType = &apos;jpg&apos;;</span><br><span class="line">            break;</span><br><span class="line">        case 13780:            </span><br><span class="line">            $fileType = &apos;png&apos;;</span><br><span class="line">            break;        </span><br><span class="line">        case 7173:            </span><br><span class="line">            $fileType = &apos;gif&apos;;</span><br><span class="line">            break;</span><br><span class="line">        default:            </span><br><span class="line">            $fileType = &apos;unknown&apos;;</span><br><span class="line">        &#125;    </span><br><span class="line">        return $fileType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>发现主要是取上传文件的头两个字节判断文件类型，因此直接上传图片马即可。</code></p>
<p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdbb2a4db5aa647e4035c18" alt=""></p>
<p>但是只能在系统存在文件包含的时候才可以配合利用 。</p>
<hr>
<h2 id="Pass-14-查看源代码："><a href="#Pass-14-查看源代码：" class="headerlink" title=" Pass-14 查看源代码："></a> Pass-14 查看源代码：</h2><p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdbb61fdb5aa647e403e100" alt=""></p>
<p><code>这里用getmagsize获取文件类型，这里还是直接利用图片马进行绕过，需要文件包含漏洞。</code></p>
<hr>
<h2 id="Pass-15-查看源代码："><a href="#Pass-15-查看源代码：" class="headerlink" title=" Pass-15 查看源代码："></a> Pass-15 查看源代码：</h2><p><code>$image_type = exif_imagetype($filename);</code></p>
<p><code>这里用到pxp_exif模块来判断文件类型，还是可以直接利用图片马进行绕过 。</code></p>
<hr>
<h2 id="Pass-16-查看源代码："><a href="#Pass-16-查看源代码：" class="headerlink" title=" Pass-16 查看源代码："></a> Pass-16 查看源代码：</h2><p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdbbe50db5aa647e4052d49" alt=""></p>
<p>判断了后缀名，content-type，以及利用imagecreatefrompng判断是否为gif图片，最后二次渲染。<br><code>imagecreatefrom 系列函数用于从文件或 URL 载入一幅图像，成功返回图像资源，失败则返回一个空字符串。</code></p>
<p>这里寻找图片被渲染后与原始图片对比任然相同的数据块部分，将代码插在该部分，然后上传，在实站中还是蛮鸡肋的，可以用winhex渲染处理图片。 </p>
<hr>
<h2 id="Pass-17-查看源代码："><a href="#Pass-17-查看源代码：" class="headerlink" title=" Pass-17 查看源代码："></a> Pass-17 查看源代码：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">if(isset($_POST[&apos;submit&apos;]))&#123;</span><br><span class="line">    $ext_arr = array(&apos;jpg&apos;,&apos;png&apos;,&apos;gif&apos;);</span><br><span class="line">    $file_name = $_FILES[&apos;upload_file&apos;][&apos;name&apos;];</span><br><span class="line">    $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];</span><br><span class="line">    $file_ext = substr($file_name,strrpos($file_name,&quot;.&quot;)+1);</span><br><span class="line">    $upload_file = UPLOAD_PATH . &apos;/&apos; . $file_name;</span><br><span class="line"></span><br><span class="line">    if(move_uploaded_file($temp_file, $upload_file))&#123;</span><br><span class="line">        if(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">             $img_path = UPLOAD_PATH . &apos;/&apos;. rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</span><br><span class="line">             rename($upload_file, $img_path);</span><br><span class="line">             $is_upload = true;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $msg = &quot;只允许上传.jpg|.png|.gif类型文件！&quot;;</span><br><span class="line">            unlink($upload_file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $msg = &apos;上传出错！&apos;;</span><br></pre></td></tr></table></figure>
<p><code>这里先将文件上传到服务器，然后通过rename修改名称，再通过unlink删除文件，因此可以通过条件竞争的方式在unlink之前，访问webshell。</code></p>
<p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdbcb5fdb5aa647e40706be" alt=""></p>
<hr>
<h2 id="Pass-18-查看源代码："><a href="#Pass-18-查看源代码：" class="headerlink" title=" Pass-18 查看源代码："></a> Pass-18 查看源代码：</h2><p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdbd9cb50f8dd54d4198868" alt=""></p>
<p>刚开始没有找到绕过方法，最后看了下通关手册:</p>
<p><code>对文件后缀名做了白名单判断，然后会一步一步检查文件大小、文件是否存在等等，将文件上传后，对文件重新命名，同样存在条件竞争的漏洞。可以不断利用burp发送上传图片马的数据包，由于条件竞争，程序会出现来不及rename的问题，从而上传成功：</code></p>
<p>然后利用Apache的解析漏洞，来获得shell，需要特殊环境才可实现，待续。</p>
<hr>
<h2 id="Pass-19-查看源代码："><a href="#Pass-19-查看源代码：" class="headerlink" title=" Pass-19 查看源代码："></a> Pass-19 查看源代码：</h2><p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdbdd0e9b521a5a85f5e5c5" alt=""></p>
<p>这里路径拼接的是处理后的文件名，并且save_name 可以自定义保存名称，故：</p>
<p><code>Content-Disposition: form-data; name=&quot;save_name&quot;</code></p>
<p><code>upload-19.php. . (点+空格+点)</code></p>
<p><img src="https://www.yunzhijia.com/microblog/filesvr/5bdbdeb350f8dd54d419e1db" alt=""></p>
<p>也可以参考Pass-12 修改二进制Hex，利用0x00截断。 </p>
<h2 id="后记"><a href="#后记" class="headerlink" title=" 后记"></a> 后记</h2><p>可以发现以上绕过方法中有些是重复的，有些是意外情况，可能与项目作者的本意不符，故本文仅作为参考使用。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/c1y2m3.github.io/">Home</a></li>
         
          <li><a href="/c1y2m3.github.io/about/">About</a></li>
         
          <li><a href="/c1y2m3.github.io/archives/">Writing</a></li>
         
          <li><a href="/c1y2m3.github.io/projects_url">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-03-查看源代码："><span class="toc-number">1.</span> <span class="toc-text">Pass-03 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-04-查看源代码"><span class="toc-number">2.</span> <span class="toc-text"> Pass-04  查看源代码:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-05-查看源代码："><span class="toc-number">3.</span> <span class="toc-text"> Pass-05 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-06-查看源代码："><span class="toc-number">4.</span> <span class="toc-text"> Pass-06 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-07-查看源代码："><span class="toc-number">5.</span> <span class="toc-text"> Pass-07 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-08-查看源代码："><span class="toc-number">6.</span> <span class="toc-text"> Pass-08 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-09-查看源代码："><span class="toc-number">7.</span> <span class="toc-text"> Pass-09 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-10-查看源代码："><span class="toc-number">8.</span> <span class="toc-text"> Pass-10 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-11-查看源代码："><span class="toc-number">9.</span> <span class="toc-text"> Pass-11 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#理解测试代码："><span class="toc-number">10.</span> <span class="toc-text">理解测试代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-12-查看源代码："><span class="toc-number">11.</span> <span class="toc-text"> Pass-12 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-13-查看源代码："><span class="toc-number">12.</span> <span class="toc-text"> Pass-13 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-14-查看源代码："><span class="toc-number">13.</span> <span class="toc-text"> Pass-14 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-15-查看源代码："><span class="toc-number">14.</span> <span class="toc-text"> Pass-15 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-16-查看源代码："><span class="toc-number">15.</span> <span class="toc-text"> Pass-16 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-17-查看源代码："><span class="toc-number">16.</span> <span class="toc-text"> Pass-17 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-18-查看源代码："><span class="toc-number">17.</span> <span class="toc-text"> Pass-18 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-19-查看源代码："><span class="toc-number">18.</span> <span class="toc-text"> Pass-19 查看源代码：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后记"><span class="toc-number">19.</span> <span class="toc-text"> 后记</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2018/11/02/upload-labs-writeup/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&text=upload-labs-writeup"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&title=upload-labs-writeup"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&is_video=false&description=upload-labs-writeup"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=upload-labs-writeup&body=Check out this article: http://yoursite.com/2018/11/02/upload-labs-writeup/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&title=upload-labs-writeup"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&title=upload-labs-writeup"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&title=upload-labs-writeup"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&title=upload-labs-writeup"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2018/11/02/upload-labs-writeup/&name=upload-labs-writeup&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/c1y2m3.github.io/">Home</a></li>
         
          <li><a href="/c1y2m3.github.io/about/">About</a></li>
         
          <li><a href="/c1y2m3.github.io/archives/">Writing</a></li>
         
          <li><a href="/c1y2m3.github.io/projects_url">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/c1y2m3.github.io/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/c1y2m3.github.io/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/c1y2m3.github.io/lib/jquery/jquery.min.js"></script>
<script src="/c1y2m3.github.io/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/c1y2m3.github.io/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


