<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>文件上传绕过总结 | c1y2m3’blog</title>
  <meta name="author" content="John Doe">
  
  <meta name="description" content="概述

一个文件以http协议上传的时候，将以post请求发送至web服务器。服务器接受并同意后，用户与web服务器建立连接，并且传输数据
上传检测流程

1.客户端javascript检测（检测文件扩展名为主）
2.服务端MIME类型检测（检测Content-type内容）
3.服务端目录路径检测">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="文件上传绕过总结">
  <meta property="og:site_name" content="c1y2m3’blog">

  
    <meta property="og:image" content="">
  

  
    <link rel="alternative" href="/c1y2m3.github.io/atom.xml" title="c1y2m3’blog" type="application/atom+xml">
  
  
    <link href="/c1y2m3.github.io/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/c1y2m3.github.io/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/c1y2m3.github.io/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/c1y2m3.github.io/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/c1y2m3.github.io/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/c1y2m3.github.io/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/c1y2m3.github.io/css/responsive.css" media="screen" type="text/css">  
  <link rel="stylesheet" href="/c1y2m3.github.io/css/sidenav.css" media="screen" type="text/css">  
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/c1y2m3.github.io/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  

</head>
</html>
<body id="body" data-spy="scroll" data-target=".toc">
  <div class="container" id="container">
	<div class="content">
	  <div class="page-header">		
  <h1><a class="brand" href="/c1y2m3.github.io/">c1y2m3’blog</a><span class="split"></span><span class="title">文件上传绕过总结</span><span class="date" id="title-date"><i class="fa fa-clock-o"></i> 2018-09-16</span></h1>
</div>		

<div class="row page">
  <!-- cols -->	
  
  

  
	<div class="col-md-12">
	  

	  <!-- content -->
	  <ul>
<li>概述</li>
</ul>
<p><code>一个文件以http协议上传的时候，将以post请求发送至web服务器。服务器接受并同意后，用户与web服务器建立连接，并且传输数据</code></p>
<p><strong>上传检测流程</strong></p>
<ul>
<li>1.客户端javascript检测（检测文件扩展名为主）</li>
<li>2.服务端MIME类型检测（检测Content-type内容）</li>
<li>3.服务端目录路径检测（检测跟path相关的内容）</li>
<li>4.服务端文件扩展名检测（检测跟文件后缀相关的内容）</li>
<li>5.服务端文件内容检测（检测内容是否合法或含有恶意代码）</li>
</ul>
<h4 id="客户端javascript检测"><a href="#客户端javascript检测" class="headerlink" title="客户端javascript检测"></a>客户端javascript检测</h4><p>通常此类检测会在js文件中有一个检测的函数，一般对上传的文件后缀名做检测,例如仅允许上传png,jpg,gif等类型的文件，如果检测到的文件后缀名不是在这些名单内，则不向服务器端传输文件内容。</p>
<p>使用burp，，通过burp拦包，并修改后缀后提交<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">_ _ _</span><br><span class="line"></span><br><span class="line">#### 服务端检测绕过（MIME类型检测）</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">	if($_FILES[&apos;userfile&apos;][&apos;type&apos;] != &quot;image/gif&quot;) &#123; //检测Content-type</span><br><span class="line">		echo &quot;Sorry, we only allow uploading GIF images&quot;;</span><br><span class="line">		exit;</span><br><span class="line">	&#125;</span><br><span class="line">	$uploaddir = &apos;uploads/&apos;;</span><br><span class="line">	$uploadfile = $uploaddir . basename($_FILES[&apos;userfile&apos;][&apos;name&apos;]);</span><br><span class="line">	if (move_uploaded_file($_FILES[&apos;userfile&apos;][&apos;tmp_name&apos;], $uploadfile)) 	  &#123;</span><br><span class="line">		echo &quot;File is valid, and was successfully uploaded.\n&quot;;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		echo &quot;File uploading failed.\n&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>通过判断$_FILES[‘userfile’][‘type’] != “image/gif”来保证上传的类型为gif类型的文件。<br><code>绕过这一类型的检测，可以通过burp拦包，将原Content-Type类型该为符合要求的image/gif类型。</code></li>
</ol>
<hr>
<h4 id="服务端检测绕过（目录路径检测）"><a href="#服务端检测绕过（目录路径检测）" class="headerlink" title="服务端检测绕过（目录路径检测）"></a>服务端检测绕过（目录路径检测）</h4><p>某些web应用，为了标识上传的图片是属于哪个文件夹的，上传文件时会带上文件存储路径，如果对目录路径检测不够完全，可以通过截断攻击。（如<strong>%00</strong>,windows下%80-%90）(0x00)</p>
<p><code>如上传时提供存储路劲为image/20160704/可以通过修改为image/20160704/evil.php%00来达到截断目的。
后端程序会将该路径连接为image/20160704/evil.php%00filename.gif 00截断导致最终存储的文件名为evil.php</code></p>
<hr>
<h4 id="服务器端检测绕过（文件扩展名检测）"><a href="#服务器端检测绕过（文件扩展名检测）" class="headerlink" title="服务器端检测绕过（文件扩展名检测）"></a>服务器端检测绕过（文件扩展名检测）</h4><ol>
<li>黑名单检测<br><code>黑名单检测通常会有一个文件后缀名黑名单</code>（例如html|htm|php|php2|php3|php4|php5…）<br>但是通常黑名单检测不能包含所有的恶意脚本后缀，防护难度会比较大，推荐使用白名单<br>绕过的方法：</li>
<li><p><code>文件名大小写绕过（例如用Php，Asp等）</code></p>
</li>
<li><p><code>名单列表绕过</code>(用黑名单中未提及的文件后缀来绕过，如asa，cer等不常见的文件后缀)</p>
</li>
<li><p><code>0x00截断</code>（asp下可以尝试使用,asp为从后往前扫描扩展名，evil.asp%00.jpg，会被识别为jpg，只要检测方式如这种可以通过这种方式绕过）</p>
</li>
<li><p><code>特殊文件名绕过</code></p>
<p>只适用windows NTFS流<br><strong>文件名改为evil.php.或evil.php(空格)，不允许这样的命名，所以会将.和空格自动去掉。</strong></p>
</li>
</ol>
<p><code>test.php::$DATA 生成test.php,有内容</code><br><code>test.php::$DATA……. 生成test.php,有内容</code><br><code>test.php::$INDEX_ALLOCATION 生成test.php文件夹</code></p>
<h4 id="htaccess文件攻击"><a href="#htaccess文件攻击" class="headerlink" title=".htaccess文件攻击"></a>.htaccess文件攻击</h4><ol start="6">
<li><p>.htaccess文件攻击（配合名单列表绕过，上传一个自定义的.htaccess，就可以轻松绕过各种检测）</p>
</li>
<li><p><code>.htaccess文件攻击</code></p>
</li>
</ol>
<p>如果黑名单中未包含.htaccess后缀的可以通过重写解析配置来达到解析的效果<br>针对php，上传自定义.htaccess。<br><img src="https://www.yunzhijia.com/microblog/filesvr/5b9e41e02711cd127f1b3a33" alt=""></p>
<p> 成因：<br><strong>在 PHP manual 中提到了下面一段话</strong></p>
<p><code>move_uploaded_file section, there is a warning which states ‘If the destination file already exists, it will be overwritten.</code></p>
<p><strong>如果 PHP 安全没配置好</strong>就可以通过 <code>move_uploaded_file</code> <strong>函数把自己写的.htaccess 文件覆盖掉服务器上的这样就能任意定义解析名单了</strong></p>
<p>这个估计很多同学看了不屑，认为是烂大街的东西了,那么下面将个新的吧。</p>
<h4 id="user-ini-文件攻击"><a href="#user-ini-文件攻击" class="headerlink" title=".user.ini 文件攻击"></a>.user.ini 文件攻击</h4><ol>
<li><p>它比.htaccess用的更广，不管是nginx/apache/IIS，只要是以fastcgi运行的php都可以用这个方法，不像.htaccess有局限性。</p>
</li>
<li><p>.user.ini都能被动态加载，也就是说我修改了.user.ini后，不需要重启服务器中间件，只需要等待<code>user_ini.cache_ttl</code> 所设置的时间即可被重新加载。</p>
</li>
</ol>
<p>只要.user.ini中可以添加 auto_prepend_file=aa.jpg ，这句话可以让其他php文件执行 自动包含01.gif ，和require()一样。   </p>
<p>原理：<code>.user.ini</code>实际上就是一个可以由用户’自定义’的php.ini，我们能够自定义的设置是模式为 ”PHP_INI_REPDIR，PHP_INI_USER”的设置。</p>
<p><img src="http://www.vuln.cn/wp-content/uploads/2016/10/e9a20f6cbd6533adefa34f7c8e16ee4f.png" alt=""></p>
<hr>
<h4 id="服务器端检测绕过（文件内容检测）"><a href="#服务器端检测绕过（文件内容检测）" class="headerlink" title="服务器端检测绕过（文件内容检测）"></a>服务器端检测绕过（文件内容检测）</h4><p> 图像类的文件内容检测<br><strong>文件幻数检测（图片头格式检测）<br>jpg内容头value= FF D8 FF E0 00 10 4A 46 49 46<br>gif内容头value= 47 49 46 38 39 61<br>png内容头value= 89 50 4E 47</strong></p>
<ul>
<li>  文件相关信息检测<br>图像文件相关信息检测常用的就是php的getimagesize()函数，可以通过修改图片的注释区（data区）插入一句话代码，如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">(...some binary data for image...)</span><br><span class="line">&lt;?php phpinfo(); ?&gt;</span><br><span class="line">(... skipping the rest of binary data ...)</span><br></pre></td></tr></table></figure>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><ol>
<li>绕过 javascript 对扩展名的检测<br> &lt;用 burp 之类的反向代理工具直接 POST 数据包到服务端，绕过前端检测&gt;</li>
<li>绕过服务端对 http request 包 MIME 类型检测<br> &lt;用 burp 之类的反向代理工具伪造 POST 数据包到服务端，绕过 MIME 检测&gt;<br>路径/扩展名检测绕过攻击<br><img src="https://raw.githubusercontent.com/cnnetarmy/uploadfile/master/image/attack_way.png" alt=""></li>
</ol>
<ul>
<li>黑白名单绕过<br>文件名大小写绕过<br>名单列表绕过<br>特殊文件名绕过<br>0x00 截断绕过<br>.htaccess 文件攻击</li>
</ul>
<hr>
<ul>
<li>白名单绕过<br>0x00 截断绕过<br>本地文件包含漏洞<br>IIS 解析漏洞<br>Nginx 解析漏洞</li>
</ul>
	  

	  <div>
  		<center>
		  <div class="pagination">
<ul class="pagination">
	
	
	
	
	
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
			
		
	
		
			
			
			
	
	
		<li class="prev"><a href="/c1y2m3.github.io/2018/09/26/ redis安全详解/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>prev</a></li>
	
	<li><a href="/c1y2m3.github.io/"><i class="fa fa-archive"></i>Home</a></li>
	
		<li class="next"><a href="/c1y2m3.github.io/2018/09/15/服务器解析漏洞(总结)/" class="alignright next">next<i class="fa fa-arrow-circle-o-right"></i></a></li>
	
</ul>
</div>

		</center>
	  </div>
	  
	</div> <!-- col-md-9/col-md-12 -->
	
  </div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
	<footer> <p>
  &copy; 2019 John Doe
  
      with help from <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-wixo/">Wixo</a>.    
</p> </footer>
  </div> <!-- container-narrow -->
  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/c1y2m3.github.io/js/jquery.imagesloaded.min.js"></script>
<script src="/c1y2m3.github.io/js/gallery.js"></script>
<script src="/c1y2m3.github.io/js/bootstrap.min.js"></script>
<script src="/c1y2m3.github.io/js/jquery.tableofcontents.min.js"></script>
<script src="/c1y2m3.github.io/js/tocgenerator.min.js"></script>
<script src="/c1y2m3.github.io/js/main.js"></script>
<script src="/c1y2m3.github.io/js/search.js"></script> 




<link rel="stylesheet" href="/c1y2m3.github.io/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/c1y2m3.github.io/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>




</body>
</html>
